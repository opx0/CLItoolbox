services:
  postgres-db:
    image: postgres:16-alpine
    container_name: postgres_prod_ready
    restart: unless-stopped

    # Use environment variables from .env file
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}

    # Performance & System Tweaks
    shm_size: 256mb # Essential for Postgres heavy queries/parallelism
    command:
      - "postgres"
      - "-c"
      - "max_connections=${POSTGRES_MAX_CONNECTIONS}"
      - "-c"
      - "shared_buffers=${POSTGRES_SHARED_BUFFERS}"
      - "-c"
      - "log_statement=all" # Good for testing; change to 'none' or 'ddl' in heavy prod

    ports:
      - "${DB_PORT}:5432"

    volumes:
      # Data persistence: Maps to a named volume
      - postgres_data:/var/lib/postgresql/data
      # Initial scripts: Any .sql or .sh in this folder runs on the FIRST start
      - ./init:/docker-entrypoint-initdb.d

    # Resource Limits (Crucial for Production)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 256M

    # Healthcheck: Ensures other services wait until DB is actually "Ready"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local
